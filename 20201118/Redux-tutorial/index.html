<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="author" content="zchengsite, 1451426471@qq.com" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  
  <title>Redux tutorial   | Macshion</title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">


  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  

<meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Macshion" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Macshion</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Links</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Redux tutorial</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="Update time"></i>
          2020-11-18
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags" title="Tags"></i>
                
                <span class="span--tag">
                  <a href="/tags/React/" title="React">
                    <b>#</b> React
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/English/" title="English">
                    <b>#</b> English
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Redux/" title="Redux">
                    <b>#</b> Redux
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h2 id="Tutorial-0-introduction"><a href="#Tutorial-0-introduction" class="headerlink" title="Tutorial 0 - introduction"></a>Tutorial 0 - introduction</h2><p>Why this tutorial?<br>While trying to learn Redux, I realized that I had accumulated incorrect knowledge about flux through<br>articles I read and personal experience. I don’t mean that articles about flux are not well written<br>but I just didn’t grasp concepts correctly. In the end, I was just applying documentation of different<br>flux frameworks (Reflux, Flummox, FB Flux) and trying to make them match with the theoretical concept I read<br>about (actions / actions creators, store, dispatcher, etc).</p>
<a id="more"></a>
<p>Only when I started using Redux did I realize that flux is more simple than I thought. This is all<br>thanks to Redux being very well designed and having removed a lot of “anti-boilerplate features” introduced<br>by other frameworks I tried before. I now feel that Redux is a much better way to learn about flux<br>than many other frameworks. That’s why I want now to share with everyone, using my own words,<br>flux concepts that I am starting to grasp, focusing on the use of Redux.</p>
<p>You may have seen this diagram representing the famous unidirectional data flow of a flux application:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">                 _________               ____________               ___________</span><br><span class="line">                |         |             |            |             |           |</span><br><span class="line">                | Action  |------------▶| Dispatcher |------------▶| callbacks |</span><br><span class="line">                |_________|             |____________|             |___________|</span><br><span class="line">                     ▲                                                   |</span><br><span class="line">                     |                                                   |</span><br><span class="line">                     |                                                   |</span><br><span class="line"> _________       ____|_____                                          ____▼____</span><br><span class="line">|         |◀----|  Action  |                                        |         |</span><br><span class="line">| Web API |     | Creators |                                        |  Store  |</span><br><span class="line">|_________|----▶|__________|                                        |_________|</span><br><span class="line">                     ▲                                                   |</span><br><span class="line">                     |                                                   |</span><br><span class="line">                 ____|________           ____________                ____▼____</span><br><span class="line">                |   User       |         |   React   |              | Change  |</span><br><span class="line">                | interactions |◀--------|   Views   |◀-------------| events  |</span><br><span class="line">                |______________|         |___________|              |_________|</span><br></pre></td></tr></table></figure>

<p>In this tutorial we’ll gradually introduce you to concepts of the diagram above. But instead of trying<br>to explain this complete diagram and the overall flow it describes, we’ll take each piece separately and try to<br>understand why it exists and what role it plays. In the end you’ll see that this diagram makes perfect sense<br>once we understand each of its parts.</p>
<p>But before we start, let’s talk a little bit about why flux exists and why we need it…<br>Let’s pretend we’re building a web application. What are all web applications made of?</p>
<ol>
<li>Templates / html = View</li>
<li>Data that will populate our views = Models</li>
<li>Logic to retrieve data, glue all views together and to react accordingly to user events,<br>data modifications, etc. = Controller</li>
</ol>
<p>This is the very classic MVC that we all know about. But it actually looks like concepts of flux,<br>just expressed in a slightly different way:</p>
<ul>
<li>Models look like stores</li>
<li>user events, data modifications and their handlers look like<br>“action creators” -&gt; action -&gt; dispatcher -&gt; callback</li>
<li>Views look like React views (or anything else as far as flux is concerned)</li>
</ul>
<p>So is flux just a matter of new vocabulary? Not exactly. But vocabulary DOES matter, because by introducing<br>these new terms we are now able to express more precisely things that were regrouped under<br>various terminologies… For example, isn’t a data fetch an action? Just like a click is also an action?<br>And a change in an input is an action too… Then we’re all already used to issuing actions from our<br>applications, we were just calling them differently. And instead of having handlers for those<br>actions directly modify Models or Views, flux ensures all actions go first through something called<br>a dispatcher, then through our stores, and finally all watchers of stores are notified.</p>
<p>To get more clarity how MVC and flux differ, we’ll<br>take a classic use-case in an MVC application:<br>In a classic MVC application you could easily end up with:</p>
<ol>
<li>User clicks on button “A”</li>
<li>A click handler on button “A” triggers a change on Model “A”</li>
<li>A change handler on Model “A” triggers a change on Model “B”</li>
<li>A change handler on Model “B” triggers a change on View “B” that re-renders itself</li>
</ol>
<p>Finding the source of a bug in such an environment when something goes wrong can become quite challenging<br>very quickly. This is because every View can watch every Model, and every Model can watch other Models, so<br>basically data can arrive from a lot of places and be changed by a lot of sources (any views or any models).</p>
<p>Whereas when using flux and its unidirectional data flow, the example above could become:</p>
<ol>
<li>user clicks on button “A”</li>
<li>a handler on button “A” triggers an action that is dispatched and produces a change on Store “A”</li>
<li>since all other stores are also notified about the action, Store B can react to the same action too</li>
<li>View “B” gets notified by the change in Stores A and B, and re-renders</li>
</ol>
<p>See how we avoid directly linking Store A to Store B? Each store can only be<br>modified by an action and nothing else. And once all stores have replied to an action,<br>views can finally update. So in the end, data always flows in one way:<br>    action -&gt; store -&gt; view -&gt; action -&gt; store -&gt; view -&gt; action -&gt; …</p>
<p>Just as we started our use case above from an action, let’s start our tutorial with<br>actions and action creators.</p>
<h2 id="Tutorial-1-simple-action-creator"><a href="#Tutorial-1-simple-action-creator" class="headerlink" title="Tutorial 1 - simple-action-creator"></a>Tutorial 1 - simple-action-creator</h2><p>We started to talk a little about actions in the introduction but what exactly are those “action creators”<br>and how are they linked to “actions”?</p>
<p>It’s actually so simple that a few lines of code can explain it all!</p>
<p>The action creator is just a function…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> actionCreator = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...that creates an action (yeah, the name action creator is pretty obvious now) and returns it</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        type: <span class="string">&#x27;AN_ACTION&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So is that all? yes.</p>
<p>However, one thing to note is the format of the action. This is kind of a convention in flux<br>that the action is an object that contains a “type” property. This type allows for further<br>handling of the action. Of course, the action can also contain other properties to<br>pass any data you want.</p>
<p>We’ll also see later that the action creator can actually return something other than an action,<br>like a function. This will be extremely useful for async action handling (more on that<br>in dispatch-async-action.js).</p>
<p>We can call this action creator and get an action as expected:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(actionCreator())</span><br><span class="line"><span class="comment">// Output: &#123; type: &#x27;AN_ACTION&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<p>Ok, this works but it does not go anywhere…<br>What we need is to have this action be sent somewhere so that<br>anyone interested could know that something happened and could act accordingly.<br>We call this process “Dispatching an action”.</p>
<p>To dispatch an action we need… a dispatch function (“Captain obvious”).<br>And to let anyone interested know that an action happened, we need a mechanism to register<br>“handlers”. Such “handlers” to actions in traditional flux application are called stores and<br>we’ll see in the next section how they are called in Redux.</p>
<p>So far here is the flow of our application:<br>ActionCreator -&gt; Action</p>
<p>Read more about actions and action creators here:</p>
<p><a target="_blank" rel="noopener" href="http://redux.js.org/docs/recipes/ReducingBoilerplate.html">http://redux.js.org/docs/recipes/ReducingBoilerplate.html</a></p>
<h2 id="Tutorial-02-about-state-and-meet-redux"><a href="#Tutorial-02-about-state-and-meet-redux" class="headerlink" title="Tutorial 02 - about-state-and-meet-redux"></a>Tutorial 02 - about-state-and-meet-redux</h2><p>Sometimes the actions that we’ll handle in our application will not only inform us<br>that something happened but also tell us that data needs to be updated.</p>
<p>This is actually quite a big challenge in any app.<br>Where do I keep all the data regarding my application along its lifetime?<br>How do I handle modification of such data?<br>How do I propagate modifications to all parts of my application?</p>
<p>Here comes Redux.</p>
<p>Redux (<a target="_blank" rel="noopener" href="https://github.com/reactjs/redux">https://github.com/reactjs/redux</a>) is a “predictable state container for JavaScript apps”</p>
<p>Let’s review the above questions and reply to them with<br>Redux vocabulary (flux vocabulary too for some of them):</p>
<p>Where do I keep all the data regarding my application along its lifetime?</p>
<pre><code>You keep it the way you want (JS object, array, Immutable structure, ...).
Data of your application will be called state. This makes sense since we&#39;re talking about
all the application&#39;s data that will evolve over time, it&#39;s really the application&#39;s state.
But you hand it over to Redux (Redux is a &quot;state container&quot;, remember?).</code></pre>
<p>How do I handle data modifications?</p>
<pre><code>Using reducers (called &quot;stores&quot; in traditional flux).
A reducer is a subscriber to actions.
A reducer is just a function that receives the current state of your application, the action,
and returns a new state modified (or reduced as they call it)</code></pre>
<p>How do I propagate modifications to all parts of my application?</p>
<pre><code>Using subscribers to state&#39;s modifications.</code></pre>
<p>Redux ties all this together for you.</p>
<p>To sum up, Redux will provide you:</p>
<pre><code>1) a place to put your application state
2) a mechanism to dispatch actions to modifiers of your application state, AKA reducers
3) a mechanism to subscribe to state updates</code></pre>
<p>The Redux instance is called a store and can be created like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="keyword">var</span> store = createStore()</span><br></pre></td></tr></table></figure>

<p>But if you run the code above, you’ll notice that it throws an error:</p>
<pre><code>Error: Invariant Violation: Expected the reducer to be a function.</code></pre>
<p>That’s because createStore expects a function that will allow it to reduce your state.</p>
<p>Let’s try again</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="keyword">var</span> store = createStore(<span class="function">() =&gt;</span> &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>Seems good for now…</p>
<h2 id="Tutorial-03-simple-reducer"><a href="#Tutorial-03-simple-reducer" class="headerlink" title="Tutorial 03 - simple-reducer"></a>Tutorial 03 - simple-reducer</h2><p>Now that we know how to create a Redux instance that will hold the state of our application<br>we will focus on those reducer functions that will allow us to transform this state.</p>
<p>A word about reducer VS store:</p>
<p>As you may have noticed, in the flux diagram shown in the introduction, we had “Store”, not<br>“Reducer” like Redux is expecting. So how exactly do Store and Reducer differ?</p>
<p>It’s more simple than you could imagine: A Store keeps your data in it while a Reducer doesn’t.<br>So in traditional flux, stores hold state in them while in Redux, each time a reducer is<br>called, it is passed the state that needs to be updated. This way, Redux’s stores became<br>“stateless stores” and were renamed reducers.</p>
<p>As stated before, when creating a Redux instance you must give it a reducer function…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="keyword">var</span> store_0 = createStore(<span class="function">() =&gt;</span> &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>… so that Redux can call this function on your application state each time an action occurs.<br>Giving reducer(s) to createStore is exactly how Redux registers the action “handlers” (read reducers) we<br>were talking about in section 01_simple-action-creator.</p>
<p>Let’s put some log in our reducer</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reducer = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Reducer was called with args&#x27;</span>, args)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> store_1 = createStore(reducer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output: Reducer was called with args [ undefined, &#123; type: &#x27;@@redux/INIT&#x27; &#125; ]</span></span><br></pre></td></tr></table></figure>

<p>Did you see that? Our reducer is actually called even if we didn’t dispatch any action…<br>That’s because to initialize the state of the application,<br>Redux actually dispatches an init action ({ type: ‘@@redux/INIT’ })</p>
<p>When called, a reducer is given those parameters: (state, action)<br>It’s then very logical that at an application initialization, the state, not being<br>initialized yet, is “undefined”</p>
<p>But then what is the state of our application after Redux sends its “init” action?</p>
<h2 id="Tutorial-04-get-state"><a href="#Tutorial-04-get-state" class="headerlink" title="Tutorial 04 - get-state"></a>Tutorial 04 - get-state</h2><p>How do we retrieve the state from our Redux instance?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reducer_0 = <span class="function"><span class="keyword">function</span> (<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;reducer_0 was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store_0 = createStore(reducer_0)</span><br><span class="line"><span class="comment">// Output: reducer_0 was called with state undefined and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<p>To get the state that Redux is holding for us, you call getState</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_0 state after initialization:&#x27;</span>, store_0.getState())</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output: store_0 state after initialization: undefined</span></span><br></pre></td></tr></table></figure>

<p>So the state of our application is still undefined after the initialization? Well of course it is,<br>our reducer is not doing anything… Remember how we described the expected behavior of a reducer in<br>“about-state-and-meet-redux”?</p>
<pre><code>&quot;A reducer is just a function that receives the current state of your application, the action,
and returns a new state modified (or reduced as they call it)&quot;</code></pre>
<p>Our reducer is not returning anything right now so the state of our application is what<br>reducer() returns, hence “undefined”.</p>
<p>Let’s try to send an initial state of our application if the state given to reducer is undefined:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reducer_1 = <span class="function"><span class="keyword">function</span> (<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;reducer_1 was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> state === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store_1 = createStore(reducer_1)</span><br><span class="line"><span class="comment">// Output: reducer_1 was called with state undefined and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_1 state after initialization:&#x27;</span>, store_1.getState())</span><br><span class="line"><span class="comment">// Output: store_1 state after initialization: &#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p>As expected, the state returned by Redux after initialization is now {}</p>
<p>There is however a much cleaner way to implement this pattern thanks to ES6:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reducer_2 = <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;reducer_2 was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store_2 = createStore(reducer_2)</span><br><span class="line"><span class="comment">// Output: reducer_2 was called with state &#123;&#125; and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_2 state after initialization:&#x27;</span>, store_2.getState())</span><br><span class="line"><span class="comment">// Output: store_2 state after initialization: &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>You’ve probably noticed that since we’ve used the default parameter on state parameter of reducer_2,<br>we no longer get undefined as state’s value in our reducer’s body.</p>
<p>Let’s now recall that a reducer is only called in response to an action dispatched and<br>let’s fake a state modification in response to an action type ‘SAY_SOMETHING’</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reducer_3 = <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;reducer_3 was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;SAY_SOMETHING&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                message: action.value</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store_3 = createStore(reducer_3)</span><br><span class="line"><span class="comment">// Output: reducer_3 was called with state &#123;&#125; and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_3 state after initialization:&#x27;</span>, store_3.getState())</span><br><span class="line"><span class="comment">// Output: store_3 state after initialization: &#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p>Nothing new in our state so far since we did not dispatch any action yet. But there are few<br>important things to pay attention to in the last example:</p>
<pre><code>0) I assumed that our action contains a type and a value property. The type property is mostly
   a convention in flux actions and the value property could have been anything else.
1) You&#39;ll often see the pattern involving a switch to respond appropriately
   to an action received in your reducers
2) When using a switch, NEVER forget to have a &quot;default: return state&quot; because
   if you don&#39;t, you&#39;ll end up having your reducer return undefined (and lose your state).
3) Notice how we returned a new state made by merging current state with &#123; message: action.value &#125;,
   all that thanks to this awesome ES7 notation (Object Spread): &#123; ...state, message: action.value &#125;
4) Note also that this ES7 Object Spread notation suits our example because it&#39;s doing a shallow
   copy of &#123; message: action.value &#125; over our state (meaning that first level properties of state
   are completely overwritten - as opposed to gracefully merged - by first level property of
   &#123; message: action.value &#125;). But if we had a more complex / nested data structure, you might choose
   to handle your state&#39;s updates very differently:

   - using Immutable.js (https://facebook.github.io/immutable-js/)
   - using Object.assign (https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign)
   - using manual merge
   - or whatever other strategy that suits your needs and the structure of your state since
     Redux is absolutely NOT opinionated on this (remember, Redux is a state container).</code></pre>
<p>Now that we’re starting to handle actions in our reducer let’s talk about having multiple reducers and<br>combining them.</p>
<h2 id="Tutorial-05-combine-reducers"><a href="#Tutorial-05-combine-reducers" class="headerlink" title="Tutorial 05 - combine-reducers"></a>Tutorial 05 - combine-reducers</h2><p>We’re now starting to get a grasp of what a reducer is…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reducer_0 = <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;reducer_0 was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;SAY_SOMETHING&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                message: action.value</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>… but before going further, we should start wondering what our reducer will look like when<br>we’ll have tens of actions:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reducer_1 = <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;reducer_1 was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;SAY_SOMETHING&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                message: action.value</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;DO_SOMETHING&#x27;</span>:</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;LEARN_SOMETHING&#x27;</span>:</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;HEAR_SOMETHING&#x27;</span>:</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;GO_SOMEWHERE&#x27;</span>:</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// etc.</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It becomes quite evident that a single reducer function cannot hold all our<br>application’s actions handling (well it could hold it, but it wouldn’t be very maintainable…).</p>
<p>Luckily for us, Redux doesn’t care if we have one reducer or a dozen and it will even help us to<br>combine them if we have many!</p>
<p>Let’s declare 2 reducers</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> userReducer = <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;userReducer was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="comment">// etc.</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> itemsReducer = <span class="function"><span class="keyword">function</span> (<span class="params">state = [], action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;itemsReducer was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="comment">// etc.</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I’d like you to pay special attention to the initial state that was actually given to<br>each reducer: userReducer got an initial state in the form of a literal object ({}) while<br>itemsReducer got an initial state in the form of an array ([]). This is just to<br>make clear that a reducer can actually handle any type of data structure. It’s really<br>up to you to decide which data structure suits your needs (an object literal, an array,<br>a boolean, a string, an immutable structure, …).</p>
<p>With this new multiple reducer approach, we will end up having each reducer handle only<br>a slice of our application state.</p>
<p>But as we already know, createStore expects just one reducer function.</p>
<p>So how do we combine our reducers? And how do we tell Redux that each reducer will only handle<br>a slice of our state?</p>
<p>It’s fairly simple. We use Redux combineReducers helper function. combineReducers takes a hash and<br>returns a function that, when invoked, will call all our reducers, retrieve the new slice of state and<br>reunite them in a state object (a simple hash {}) that Redux is holding.</p>
<p>Long story short, here is how you create a Redux instance with multiple reducers:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reducer = combineReducers(&#123;</span><br><span class="line">    user: userReducer,</span><br><span class="line">    items: itemsReducer</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// userReducer was called with state &#123;&#125; and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br><span class="line"><span class="comment">// userReducer was called with state &#123;&#125; and action &#123; type: &#x27;@@redux/PROBE_UNKNOWN_ACTION_9.r.k.r.i.c.n.m.i&#x27; &#125;</span></span><br><span class="line"><span class="comment">// itemsReducer was called with state [] and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br><span class="line"><span class="comment">// itemsReducer was called with state [] and action &#123; type: &#x27;@@redux/PROBE_UNKNOWN_ACTION_4.f.i.z.l.3.7.s.y.v.i&#x27; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store_0 = createStore(reducer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// userReducer was called with state &#123;&#125; and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br><span class="line"><span class="comment">// itemsReducer was called with state [] and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<p>As you can see in the output, each reducer is correctly called with the init action @@redux/INIT.<br>But what is this other action? This is a sanity check implemented in combineReducers<br>to assure that a reducer will always return a state != ‘undefined’.</p>
<p>Please note also that the first invocation of init actions in combineReducers share the same purpose<br>as random actions (to do a sanity check).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_0 state after initialization:&#x27;</span>, store_0.getState())</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// store_0 state after initialization: &#123; user: &#123;&#125;, items: [] &#125;</span></span><br></pre></td></tr></table></figure>

<p>It’s interesting to note that Redux handles our slices of state correctly,<br>the final state is indeed a simple hash made of the userReducer’s slice and the itemsReducer’s slice:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    user: &#123;&#125;, <span class="comment">// &#123;&#125; is the slice returned by our userReducer</span></span><br><span class="line">    items: [] <span class="comment">// [] is the slice returned by our itemsReducer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Since we initialized the state of each of our reducers with a specific value ({} for userReducer and<br>[] for itemsReducer) it’s no coincidence that those values are found in the final Redux state.</p>
<p>By now we have a good idea of how reducers will work. It would be nice to have some<br>actions being dispatched and see the impact on our Redux state.</p>
<h2 id="Tutorial-06-dispatch-action"><a href="#Tutorial-06-dispatch-action" class="headerlink" title="Tutorial 06 - dispatch-action"></a>Tutorial 06 - dispatch-action</h2><p>So far we’ve focused on building our reducer(s) and we haven’t dispatched any of our own actions.<br>We’ll keep the same reducers from our previous tutorial and handle a few actions:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> userReducer = <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;userReducer was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;SET_NAME&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                name: action.name</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> itemsReducer = <span class="function"><span class="keyword">function</span> (<span class="params">state = [], action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;itemsReducer was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;ADD_ITEM&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                ...state,</span><br><span class="line">                action.item</span><br><span class="line">            ]</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reducer = combineReducers(&#123;</span><br><span class="line">    user: userReducer,</span><br><span class="line">    items: itemsReducer</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> store_0 = createStore(reducer)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;\n&quot;</span>, <span class="string">&#x27;### It starts here&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_0 state after initialization:&#x27;</span>, store_0.getState())</span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// store_0 state after initialization: &#123; user: &#123;&#125;, items: [] &#125;</span></span><br></pre></td></tr></table></figure>

<p>Let’s dispatch our first action… Remember in ‘simple-action-creator’ we said:</p>
<pre><code>&quot;To dispatch an action we need... a dispatch function.&quot; Captain obvious</code></pre>
<p>The dispatch function we’re looking for is provided by Redux and will propagate our action<br>to all of our reducers! The dispatch function is accessible through the Redux<br>instance property “dispatch”</p>
<p>To dispatch an action, simply call:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">store_0.dispatch(&#123;</span><br><span class="line">    type: <span class="string">&#x27;AN_ACTION&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// userReducer was called with state &#123;&#125; and action &#123; type: &#x27;AN_ACTION&#x27; &#125;</span></span><br><span class="line"><span class="comment">// itemsReducer was called with state [] and action &#123; type: &#x27;AN_ACTION&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<p>Each reducer is effectively called but since none of our reducers care about this action type,<br>the state is left unchanged:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_0 state after action AN_ACTION:&#x27;</span>, store_0.getState())</span><br><span class="line"><span class="comment">// Output: store_0 state after action AN_ACTION: &#123; user: &#123;&#125;, items: [] &#125;</span></span><br></pre></td></tr></table></figure>

<p>But, wait a minute! Aren’t we supposed to use an action creator to send an action? </p>
<p>We could indeed use an actionCreator but since all it does is return an action it would not bring anything more to this example. But for the sake of future difficulties let’s do it the right way according to<br>flux theory. And let’s make this action creator send an action we actually care about:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> setNameActionCreator = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        type: <span class="string">&#x27;SET_NAME&#x27;</span>,</span><br><span class="line">        name: name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">store_0.dispatch(setNameActionCreator(<span class="string">&#x27;bob&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// userReducer was called with state &#123;&#125; and action &#123; type: &#x27;SET_NAME&#x27;, name: &#x27;bob&#x27; &#125;</span></span><br><span class="line"><span class="comment">// itemsReducer was called with state [] and action &#123; type: &#x27;SET_NAME&#x27;, name: &#x27;bob&#x27; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_0 state after action SET_NAME:&#x27;</span>, store_0.getState())</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// store_0 state after action SET_NAME: &#123; user: &#123; name: &#x27;bob&#x27; &#125;, items: [] &#125;</span></span><br></pre></td></tr></table></figure>

<p>We just handled our first action and it changed the state of our application!</p>
<p>But this seems too simple and not close enough to a real use-case. For example,<br>what if we’d like do some async work in our action creator before dispatching<br>the action? We’ll talk about that in the next tutorial.</p>
<p>So far here is the flow of our application<br>ActionCreator -&gt; Action -&gt; dispatcher -&gt; reducer</p>
<h2 id="Tutorial-07-dispatch-async-action-1"><a href="#Tutorial-07-dispatch-async-action-1" class="headerlink" title="Tutorial 07 - dispatch-async-action-1"></a>Tutorial 07 - dispatch-async-action-1</h2><p>We previously saw how we can dispatch actions and how those actions will modify<br>the state of our application thanks to reducers.</p>
<p>But so far we’ve only considered synchronous actions or, more exactly, action creators<br>that produce an action synchronously: when called an action is returned immediately.</p>
<p>Let’s now imagine a simple asynchronous use-case:</p>
<ol>
<li>user clicks on button “Say Hi in 2 seconds”</li>
<li>When button “A” is clicked, we’d like to show message “Hi” after 2 seconds have elapsed</li>
<li>2 seconds later, our view is updated with the message “Hi”</li>
</ol>
<p>Of course this message is part of our application state so we have to save it<br>in Redux store. But what we want is to have our store save the message<br>only 2 seconds after the action creator is called (because if we were to update our state<br>immediately, any subscriber to state’s modifications - like our view - would be notified right away<br>and would then react to this update 2 seconds too soon).</p>
<p>If we were to call an action creator like we did until now…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reducer = combineReducers(&#123;</span><br><span class="line">    speaker: <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;speaker was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;SAY&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...state,</span><br><span class="line">                    message: action.message</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> store_0 = createStore(reducer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sayActionCreator = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        type: <span class="string">&#x27;SAY&#x27;</span>,</span><br><span class="line">        message</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;\n&quot;</span>, <span class="string">&#x27;Running our normal action creator:&#x27;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">store_0.dispatch(sayActionCreator(<span class="string">&#x27;Hi&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;store_0 state after action SAY:&#x27;</span>, store_0.getState())</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output (skipping initialization output):</span></span><br><span class="line"><span class="comment">//     Sun Aug 02 2015 01:03:05 GMT+0200 (CEST)</span></span><br><span class="line"><span class="comment">//     speaker was called with state &#123;&#125; and action &#123; type: &#x27;SAY&#x27;, message: &#x27;Hi&#x27; &#125;</span></span><br><span class="line"><span class="comment">//     Sun Aug 02 2015 01:03:05 GMT+0200 (CEST)</span></span><br><span class="line"><span class="comment">//     store_0 state after action SAY: &#123; speaker: &#123; message: &#x27;Hi&#x27; &#125; &#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>… then we see that our store is updated immediately.</p>
<p>What we’d like instead is an action creator that looks a bit like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> asyncSayActionCreator_0 = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            type: <span class="string">&#x27;SAY&#x27;</span>,</span><br><span class="line">            message</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But then our action creator would not return an action, it would return “undefined”. So this is not<br>quite the solution we’re looking for.</p>
<p>Here’s the trick: instead of returning an action, we’ll return a function. And this function will be the<br>one to dispatch the action when it seems appropriate to do so. But if we want our function to be able to<br>dispatch the action it should be given the dispatch function. Then, this should look like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> asyncSayActionCreator_1 = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            dispatch(&#123;</span><br><span class="line">                type: <span class="string">&#x27;SAY&#x27;</span>,</span><br><span class="line">                message</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Again you’ll notice that our action creator is not returning an action, it is returning a function.<br>So there is a high chance that our reducers won’t know what to do with it. But you never know, so let’s<br>try it out and find out what happens…</p>
<h2 id="Tutorial-08-dispatch-async-action-2"><a href="#Tutorial-08-dispatch-async-action-2" class="headerlink" title="Tutorial 08 - dispatch-async-action-2"></a>Tutorial 08 - dispatch-async-action-2</h2><p>Let’s try to run the first async action creator that we wrote in dispatch-async-action-1.js.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reducer = combineReducers(&#123;</span><br><span class="line">    speaker: <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;speaker was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;SAY&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...state,</span><br><span class="line">                    message: action.message</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> store_0 = createStore(reducer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> asyncSayActionCreator_1 = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            dispatch(&#123;</span><br><span class="line">                type: <span class="string">&#x27;SAY&#x27;</span>,</span><br><span class="line">                message</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;\n&quot;</span>, <span class="string">&#x27;Running our async action creator:&#x27;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">store_0.dispatch(asyncSayActionCreator_1(<span class="string">&#x27;Hi&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">//     ...</span></span><br><span class="line"><span class="comment">//     /Users/classtar/Codes/redux-tutorial/node_modules/redux/node_modules/invariant/invariant.js:51</span></span><br><span class="line"><span class="comment">//         throw error;</span></span><br><span class="line"><span class="comment">//               ^</span></span><br><span class="line"><span class="comment">//     Error: Invariant Violation: Actions must be plain objects. Use custom middleware for async actions.</span></span><br><span class="line"><span class="comment">//     ...</span></span><br></pre></td></tr></table></figure>

<p>It seems that our function didn’t even reach our reducers. But Redux has been kind enough to give us a<br>tip: “Use custom middleware for async actions.”. It looks like we’re on the right path but what is this<br>“middleware” thing?</p>
<p>Just to reassure you, our action creator asyncSayActionCreator_1 is well-written and will work as expected<br>as soon as we’ve figured out what middleware is and how to use it.</p>
<h2 id="Tutorial-09-middleware"><a href="#Tutorial-09-middleware" class="headerlink" title="Tutorial 09 - middleware"></a>Tutorial 09 - middleware</h2><p>We left dispatch-async-action-2 with a new concept: “middleware”. Somehow middleware should help us<br>to solve async action handling. So what exactly is middleware?</p>
<p>Generally speaking middleware is something that goes between parts A and B of an application to<br>transform what A sends before passing it to B. So instead of having:<br>A —–&gt; B<br>we end up having<br>A —&gt; middleware 1 —&gt; middleware 2 —&gt; middleware 3 –&gt; … —&gt; B</p>
<p>How could middleware help us in the Redux context? Well it seems that the function that we are<br>returning from our async action creator cannot be handled natively by Redux but if we had a<br>middleware between our action creator and our reducers, we could transform this function into something<br>that suits Redux:</p>
<p>action —&gt; dispatcher —&gt; middleware 1 —&gt; middleware 2 —&gt; reducers</p>
<p>Our middleware will be called each time an action (or whatever else, like a function in our<br>async action creator case) is dispatched and it should be able to help our action creator<br>dispatch the real action when it wants to (or do nothing - this is a totally valid and<br>sometimes desired behavior).</p>
<p>In Redux, middleware are functions that must conform to a very specific signature and follow<br>a strict structure:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    var anyMiddleware = function (&#123; dispatch, getState &#125;) &#123;</span></span><br><span class="line"><span class="comment">        return function(next) &#123;</span></span><br><span class="line"><span class="comment">            return function (action) &#123;</span></span><br><span class="line"><span class="comment">                // your middleware-specific code goes here</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>As you can see above, a middleware is made of 3 nested functions (that will get called sequentially):</p>
<ol>
<li>The first level provides the dispatch function and a getState function (if your<br> middleware or your action creator needs to read data from state) to the 2 other levels</li>
<li>The second level provides the next function that will allow you to explicitly hand over<br> your transformed input to the next middleware or to Redux (so that Redux can finally call all reducers).</li>
<li>the third level provides the action received from the previous middleware or from your dispatch<br> and can either trigger the next middleware (to let the action continue to flow) or process<br> the action in any appropriate way.</li>
</ol>
<p>Those of you who are trained to functional programming may have recognized above an opportunity<br>to apply a functional pattern: currying (if you aren’t, don’t worry, skipping the next 10 lines<br>won’t affect your Redux understanding). Using currying, you could simplify the above function like that:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    // &quot;curry&quot; may come from any functional programming library (lodash, ramda, etc.)</span></span><br><span class="line"><span class="comment">    var thunkMiddleware = curry(</span></span><br><span class="line"><span class="comment">        (&#123;dispatch, getState&#125;, next, action) =&gt; (</span></span><br><span class="line"><span class="comment">            // your middleware-specific code goes here</span></span><br><span class="line"><span class="comment">        )</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>The middleware we have to build for our async action creator is called a thunk middleware and<br>its code is provided here: <a target="_blank" rel="noopener" href="https://github.com/gaearon/redux-thunk">https://github.com/gaearon/redux-thunk</a>.<br>Here is what it looks like (with function body translated to es5 for readability):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> thunkMiddleware = <span class="function"><span class="keyword">function</span> (<span class="params">&#123; dispatch, getState &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log(&#x27;Enter thunkMiddleware&#x27;);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// console.log(&#x27;Function &quot;next&quot; provided:&#x27;, next);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">action</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// console.log(&#x27;Handling action:&#x27;, action);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span> ?</span><br><span class="line">                action(dispatch, getState) :</span><br><span class="line">                next(action)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To tell Redux that we have one or more middlewares, we must use one of Redux’s<br>helper functions: applyMiddleware.</p>
<p>“applyMiddleware” takes all your middlewares as parameters and returns a function to be called<br>with Redux createStore. When this last function is invoked, it will produce “a higher-order<br>store that applies middleware to a store’s dispatch”.</p>
<p>(from <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux/blob/master/src/applyMiddleware.js">https://github.com/reactjs/redux/blob/master/src/applyMiddleware.js</a>)</p>
<p>Here is how you would integrate a middleware into your Redux store:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, combineReducers, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> finalCreateStore = applyMiddleware(thunkMiddleware)(createStore)</span><br><span class="line"><span class="comment">// For multiple middlewares, write: applyMiddleware(middleware1, middleware2, ...)(createStore)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reducer = combineReducers(&#123;</span><br><span class="line">    speaker: <span class="function"><span class="keyword">function</span> (<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;speaker was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;SAY&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...state,</span><br><span class="line">                    message: action.message</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> state</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store_0 = finalCreateStore(reducer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">//     speaker was called with state &#123;&#125; and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br><span class="line"><span class="comment">//     speaker was called with state &#123;&#125; and action &#123; type: &#x27;@@redux/PROBE_UNKNOWN_ACTION_s.b.4.z.a.x.a.j.o.r&#x27; &#125;</span></span><br><span class="line"><span class="comment">//     speaker was called with state &#123;&#125; and action &#123; type: &#x27;@@redux/INIT&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<p>Now that we have our middleware-ready store instance, let’s try again to dispatch our async action:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> asyncSayActionCreator_1 = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>(), <span class="string">&#x27;Dispatch action now:&#x27;</span>)</span><br><span class="line">            dispatch(&#123;</span><br><span class="line">                type: <span class="string">&#x27;SAY&#x27;</span>,</span><br><span class="line">                message</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;\n&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>(), <span class="string">&#x27;Running our async action creator:&#x27;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">store_0.dispatch(asyncSayActionCreator_1(<span class="string">&#x27;Hi&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">//     Mon Aug 03 2015 00:01:20 GMT+0200 (CEST) Running our async action creator:</span></span><br><span class="line"><span class="comment">//     Mon Aug 03 2015 00:01:22 GMT+0200 (CEST) &#x27;Dispatch action now:&#x27;</span></span><br><span class="line"><span class="comment">//     speaker was called with state &#123;&#125; and action &#123; type: &#x27;SAY&#x27;, message: &#x27;Hi&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<p>Our action is correctly dispatched 2 seconds after our call the async action creator!</p>
<p>Just for your curiosity, here is how a middleware to log all actions that are dispatched, would<br>look like:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logMiddleware</span> (<span class="params">&#123; dispatch, getState &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">action</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;logMiddleware action received:&#x27;</span>, action)</span><br><span class="line">            <span class="keyword">return</span> next(action)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Same below for a middleware to discard all actions that are dispatched (not very useful as is<br>but with a bit of more logic it could selectively discard a few actions while passing others<br>to next middleware or Redux):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">discardMiddleware</span> (<span class="params">&#123; dispatch, getState &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">action</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;discardMiddleware action received:&#x27;</span>, action)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Try to modify finalCreateStore call above by using the logMiddleware and / or the discardMiddleware<br>and see what happens…</p>
<p>For example, using:</p>
<pre><code>const finalCreateStore = applyMiddleware(discardMiddleware, thunkMiddleware)(createStore)</code></pre>
<p>should make your actions never reach your thunkMiddleware and even less your reducers.</p>
<p>See <a target="_blank" rel="noopener" href="http://redux.js.org/docs/introduction/Ecosystem.html#middleware">http://redux.js.org/docs/introduction/Ecosystem.html#middleware</a>, section Middleware, to<br>see other middleware examples.</p>
<p>Let’s sum up what we’ve learned so far:</p>
<ol>
<li>We know how to write actions and action creators</li>
<li>We know how to dispatch our actions</li>
<li>We know how to handle custom actions like asynchronous actions thanks to middlewares</li>
</ol>
<p>The only missing piece to close the loop of Flux application is to be notified about<br>state updates in order to react to them (by re-rendering our components for example).</p>
<p>So how do we subscribe to our Redux store updates?</p>
<h2 id="Tutorial-10-state-subscriber"><a href="#Tutorial-10-state-subscriber" class="headerlink" title="Tutorial 10 - state-subscriber"></a>Tutorial 10 - state-subscriber</h2><p>We’re close to having a complete Flux loop but we still miss one critical part:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> _________      _________       ___________</span><br><span class="line">|         |    | Change  |     |   React   |</span><br><span class="line">|  Store  |----▶ events  |-----▶   Views   |</span><br><span class="line">|_________|    |_________|     |___________|</span><br></pre></td></tr></table></figure>
<p>Without it, we cannot update our views when the store changes.</p>
<p>Fortunately, there is a very simple way to “watch” over our Redux store’s updates:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    store.subscribe(function() &#123;</span></span><br><span class="line"><span class="comment">        // retrieve latest store state here</span></span><br><span class="line"><span class="comment">        // Ex:</span></span><br><span class="line"><span class="comment">        console.log(store.getState());</span></span><br><span class="line"><span class="comment">    &#125;)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>Yeah… So simple that it almost makes us believe in Santa Claus again.</p>
<p>Let’s try this out:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> itemsReducer = <span class="function"><span class="keyword">function</span> (<span class="params">state = [], action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;itemsReducer was called with state&#x27;</span>, state, <span class="string">&#x27;and action&#x27;</span>, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;ADD_ITEM&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                ...state,</span><br><span class="line">                action.item</span><br><span class="line">            ]</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reducer = combineReducers(&#123; <span class="attr">items</span>: itemsReducer &#125;)</span><br><span class="line"><span class="keyword">var</span> store_0 = createStore(reducer)</span><br><span class="line"></span><br><span class="line">store_0.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;store_0 has been updated. Latest store state:&#x27;</span>, store_0.getState());</span><br><span class="line">    <span class="comment">// Update your views here</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> addItemActionCreator = <span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        type: <span class="string">&#x27;ADD_ITEM&#x27;</span>,</span><br><span class="line">        item: item</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">store_0.dispatch(addItemActionCreator(&#123; <span class="attr">id</span>: <span class="number">1234</span>, <span class="attr">description</span>: <span class="string">&#x27;anything&#x27;</span> &#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">//     ...</span></span><br><span class="line"><span class="comment">//     store_0 has been updated. Latest store state: &#123; items: [ &#123; id: 1234, description: &#x27;anything&#x27; &#125; ] &#125;</span></span><br></pre></td></tr></table></figure>

<p>Our subscribe callback is correctly called and our store now contains the new item that we added.</p>
<p>Theoretically speaking we could stop here. Our Flux loop is closed, we understood all concepts that make<br>Flux and we saw that it is not that much of a mystery. But to be honest, there is still a lot to talk<br>about and a few things in the last example were intentionally left aside to keep the simplest form of this<br>last Flux concept:</p>
<ul>
<li>Our subscriber callback did not receive the state as a parameter, why?</li>
<li>Since we did not receive our new state, we were bound to exploit our closured store (store_0) so this<br>  solution is not acceptable in a real multi-modules application…</li>
<li>How do we actually update our views?</li>
<li>How do we unsubscribe from store updates?</li>
<li>More generally speaking, how should we integrate Redux with React?</li>
</ul>
<p>We’re now entering a more “Redux inside React” specific domain.</p>
<p>It is very important to understand that Redux is by no means bound to React. It is really a<br>“Predictable state container for JavaScript apps” and you can use it in many ways, a React<br>application just being one of them.</p>
<p>In that perspective we would be a bit lost if it wasn’t for react-redux </p>
<p>(<a target="_blank" rel="noopener" href="https://github.com/reactjs/react-redux">https://github.com/reactjs/react-redux</a>).</p>
<p>Previously integrated inside Redux (before 1.0.0), this repository holds all the bindings we need to simplify<br>our life when using Redux inside React.</p>
<p>Back to our “subscribe” case… Why exactly do we have this subscribe function that seems so simple but at<br>the same time also seems to not provide enough features?</p>
<p>Its simplicity is actually its power! Redux, with its current minimalist API (including “subscribe”) is<br>highly extensible and this allows developers to build some crazy products like the Redux DevTools</p>
<p>(<a target="_blank" rel="noopener" href="https://github.com/gaearon/redux-devtools">https://github.com/gaearon/redux-devtools</a>).</p>
<p>But in the end we still need a “better” API to subscribe to our store changes. That’s exactly what react-redux<br>brings us: an API that will allow us to seamlessly fill the gap between the raw Redux subscribing mechanism<br>and our developer expectations. In the end, you won’t need to use “subscribe” directly. Instead you will<br>use bindings such as “provide” or “connect” and those will hide from you the “subscribe” method.</p>
<p>So yeah, the “subscribe” method will still be used but it will be done through a higher order API that<br>handles access to Redux state for you.</p>
<p>We’ll now cover those bindings and show how simple it is to wire your components to Redux’s state.</p>
<h2 id="Tutorial-11-Provider-and-connect"><a href="#Tutorial-11-Provider-and-connect" class="headerlink" title="Tutorial 11 - Provider-and-connect"></a>Tutorial 11 - Provider-and-connect</h2><p>This is the final tutorial and the one that will show you how to bind together Redux and React.</p>
<p>To run this example, you will need a browser.</p>
<p>All explanations for this example are inlined in the sources inside ./11_src/src/.</p>
<p>Once you’ve read the lines below, start with 11_src/src/server.js.</p>
<p>To build our React application and serve it to a browser, we’ll use:</p>
<ul>
<li>A very simple node HTTP server (<a target="_blank" rel="noopener" href="https://nodejs.org/api/http.html">https://nodejs.org/api/http.html</a>)</li>
<li>The awesome Webpack (<a target="_blank" rel="noopener" href="http://webpack.github.io/">http://webpack.github.io/</a>) to bundle our application,</li>
<li>The magic Webpack Dev Server (<a target="_blank" rel="noopener" href="http://webpack.github.io/docs/webpack-dev-server.html">http://webpack.github.io/docs/webpack-dev-server.html</a>)<br>  to serve JS files from a dedicated node server that allows for files watch</li>
<li>The incredible React Hot Loader <a target="_blank" rel="noopener" href="http://gaearon.github.io/react-hot-loader/">http://gaearon.github.io/react-hot-loader/</a> (another awesome project of Dan Abramov - just in case, he is Redux’s author) to have a crazy<br>  DX (Developer experience) by having our components live-reload in the browser<br>  while we’re tweaking them in our code editor.</li>
</ul>
<p>An important point for those of you who are already using React: this application is built<br>upon React 0.14.</p>
<p>I won’t detail Webpack Dev Server and React Hot Loader setup here since it’s done pretty<br>well in React Hot Loader’s docs.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> webpackDevServer <span class="keyword">from</span> <span class="string">&#x27;./11_src/src/webpack-dev-server&#x27;</span></span><br><span class="line"><span class="comment">// We request the main server of our app to start it from this file.</span></span><br><span class="line"><span class="keyword">import</span> server <span class="keyword">from</span> <span class="string">&#x27;./11_src/src/server&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Change the port below if port 5050 is already in use for you.</span></span><br><span class="line"><span class="comment">// if port equals X, we&#x27;ll use X for server&#x27;s port and X+1 for webpack-dev-server&#x27;s port</span></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">5050</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Start our Webpack dev server...</span></span><br><span class="line">webpackDevServer.listen(port)</span><br><span class="line"><span class="comment">// ... and our main app server.</span></span><br><span class="line">server.listen(port)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Server is listening on http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Tutorial-12-final-words"><a href="#Tutorial-12-final-words" class="headerlink" title="Tutorial 12 - final-words"></a>Tutorial 12 - final-words</h2><p>There is actually more to Redux and react-redux than what we showed you with this tutorial. For example,<br>concerning Redux, you may be interested in bindActionCreators,to produce a hash of action creators<br>already bound to dispatch</p>
<p> (<a target="_blank" rel="noopener" href="http://redux.js.org/docs/api/bindActionCreators.html">http://redux.js.org/docs/api/bindActionCreators.html</a>).</p>
<p>We hope we’ve given you the keys to better understand Flux and to see more clearly<br>how Flux implementations differ from one another - especially how Redux stands out ;).</p>
<p>Where to go from here?</p>
<p>The official Redux documentation is really awesome and exhaustive so you should not hesitate to<br>refer to it from now on: <a target="_blank" rel="noopener" href="http://redux.js.org/">http://redux.js.org/</a></p>
<p>You also can find this tutorial in: <a target="_blank" rel="noopener" href="https://github.com/happypoulp/redux-tutorial">https://github.com/happypoulp/redux-tutorial</a></p>
<p>Have fun with React and Redux!</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/20190812/svg-basic1/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="Update time"></i>
              2020-11-18
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="Tags"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/React/" title="React">
                        <b>#</b> React
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/English/" title="English">
                        <b>#</b> English
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Redux/" title="Redux">
                        <b>#</b> Redux
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/20201119/chrome-extensions/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div class="post-catalog" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-0-introduction"><span class="toc-text">Tutorial 0 - introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-1-simple-action-creator"><span class="toc-text">Tutorial 1 - simple-action-creator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-02-about-state-and-meet-redux"><span class="toc-text">Tutorial 02 - about-state-and-meet-redux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-03-simple-reducer"><span class="toc-text">Tutorial 03 - simple-reducer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-04-get-state"><span class="toc-text">Tutorial 04 - get-state</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-05-combine-reducers"><span class="toc-text">Tutorial 05 - combine-reducers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-06-dispatch-action"><span class="toc-text">Tutorial 06 - dispatch-action</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-07-dispatch-async-action-1"><span class="toc-text">Tutorial 07 - dispatch-async-action-1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-08-dispatch-async-action-2"><span class="toc-text">Tutorial 08 - dispatch-async-action-2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-09-middleware"><span class="toc-text">Tutorial 09 - middleware</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-10-state-subscriber"><span class="toc-text">Tutorial 10 - state-subscriber</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-11-Provider-and-connect"><span class="toc-text">Tutorial 11 - Provider-and-connect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tutorial-12-final-words"><span class="toc-text">Tutorial 12 - final-words</span></a></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        





      </div>
    
  </div>


        <div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/macshion">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/_Macshion">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="weibo" target="_blank" rel="noopener" href="https://weibo.com/1909056972">
            <i class="iconfont icon-weibo"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    <div class="footer-more">
      
        <a href="https://macshion.github.io/">Copyright © Macshion 2019+</a>
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
